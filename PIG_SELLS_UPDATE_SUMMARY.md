# สรุปการอัปเดตระบบขายหมู (Pig Sells System)

## 📅 วันที่อัปเดต: 12 ตุลาคม 2025

---

## 🎯 วัตถุประสงค์การอัปเดต

เปลี่ยนระบบขายหมูจาก **ระบบขายทั่วไป** เป็น **ระบบขายให้นายหน้า** ที่มีการจัดการลูกค้า การให้เครดิต และการติดตามการชำระเงินแบบมืออาชีพ

---

## 📊 สิ่งที่เปลี่ยนแปลงในฐานข้อมูล

### 1. ตาราง `customers` (ใหม่ - สร้างขึ้นมาใหม่)
**จุดประสงค์:** เก็บข้อมูลลูกค้า (นายหน้า) ที่ซื้อหมูจากฟาร์ม

| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `customer_code` | รหัสลูกค้า (สร้างอัตโนมัติ) | CUST-001, CUST-002 |
| `customer_name` | ชื่อลูกค้า/บริษัท | บริษัท ABC จำกัด |
| `customer_type` | ประเภท | นายหน้า, โรงฆ่าสัตว์, ร้านค้า |
| `contact_person` | ชื่อผู้ติดต่อ | คุณสมชาย |
| `phone` | เบอร์โทร | 081-234-5678 |
| `email` | อีเมล | somchai@abc.com |
| `address` | ที่อยู่ | 123 ถ.พระราม 9 |
| `tax_id` | เลขประจำตัวผู้เสียภาษี | 0123456789012 |
| `credit_days` | ระยะเวลาเครดิต (วัน) | 30, 60, 90 |
| `credit_limit` | วงเงินเครดิตสูงสุด (บาท) | 500,000.00 |
| `total_purchased` | ยอดซื้อสะสมทั้งหมด | 1,250,000.00 |
| `total_outstanding` | ยอดค้างชำระปัจจุบัน | 150,000.00 |
| `last_purchase_date` | วันที่ซื้อล่าสุด | 2025-10-10 |
| `is_active` | สถานะใช้งาน | 1 = ใช้งาน, 0 = ปิด |

**ตัวอย่างข้อมูล:**
```
CUST-001 | บริษัท สมบูรณ์เนื้อสด จำกัด | นายหน้า | เครดิต 60 วัน | วงเงิน 1,000,000 บาท
CUST-002 | โรงฆ่าสัตว์ไทยรุ่งเรือง | โรงฆ่าสัตว์ | เครดิต 30 วัน | วงเงิน 500,000 บาท
```

---

### 2. ตาราง `pig_sells` (เพิ่มคอลัมน์ใหม่ 23 คอลัมน์)

#### 📌 กลุ่มข้อมูลลูกค้า
| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `customer_id` | รหัสลูกค้า (เชื่อมโยงตาราง customers) | 1, 2, 3 |
| `sale_number` | เลขที่ขาย (สร้างอัตโนมัติ) | SELL-2025-001 |

#### 📌 กลุ่มน้ำหนัก
| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `estimated_weight` | น้ำหนักประมาณการ (kg) | 5,500.00 |
| `actual_weight` | น้ำหนักชั่งจริง (kg) | 5,450.00 |
| `avg_weight_per_pig` | น้ำหนักเฉลี่ยต่อตัว (kg) | 109.00 |

**อธิบาย:** 
- `estimated_weight` = น้ำหนักที่คาดการณ์ตอนยังไม่ได้ชั่ง
- `actual_weight` = น้ำหนักจริงตอนชั่งก่อนส่ง (ใช้คำนวณราคาจริง)
- `avg_weight_per_pig` = คำนวณอัตโนมัติ = actual_weight / quantity

#### 📌 กลุ่มราคา
| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `discount` | ส่วนลด (บาท) | 5,000.00 |
| `shipping_cost` | ค่าขนส่ง (บาท) | 3,000.00 |
| `net_total` | ราคาสุทธิ (บาท) | 598,000.00 |

**สูตรคำนวณ:**
```
net_total = total_price - discount + shipping_cost
```

**ตัวอย่าง:**
```
ราคารวม (total_price)     = 600,000.00
หัก ส่วนลด (discount)      =   5,000.00
บวก ค่าขนส่ง (shipping_cost) = 3,000.00
                          _______________
ราคาสุทธิ (net_total)     = 598,000.00
```

#### 📌 กลุ่มการชำระเงิน
| คอลัมน์ | ความหมาย | ค่าที่เป็นไปได้ |
|---------|----------|----------------|
| `payment_method` | วิธีชำระเงิน | เงินสด, โอนเงิน |
| `payment_term` | เงื่อนไขการชำระ | เงินสด, เครดิต 30 วัน, 60 วัน, 90 วัน |
| `payment_status` | สถานะการชำระ | รอชำระ, ชำระบางส่วน, ชำระแล้ว, เกินกำหนด |
| `paid_amount` | ยอดที่ชำระแล้ว | 300,000.00 |
| `balance` | ยอดคงเหลือ | 298,000.00 |
| `due_date` | วันครบกำหนดชำระ | 2025-11-10 |
| `paid_date` | วันที่ชำระครบ | 2025-11-05 |

**ตัวอย่างการใช้งาน:**

**กรณีที่ 1: ชำระเงินสดทันที**
```
payment_method  = "เงินสด"
payment_term    = "เงินสด"
payment_status  = "ชำระแล้ว"
paid_amount     = 598,000.00
balance         = 0.00
due_date        = NULL
paid_date       = 2025-10-12
```

**กรณีที่ 2: ให้เครดิต 30 วัน (ยังไม่ชำระ)**
```
payment_method  = "โอนเงิน"
payment_term    = "เครดิต 30 วัน"
payment_status  = "รอชำระ"
paid_amount     = 0.00
balance         = 598,000.00
due_date        = 2025-11-12
paid_date       = NULL
```

**กรณีที่ 3: ชำระบางส่วน**
```
payment_method  = "โอนเงิน"
payment_term    = "เครดิต 30 วัน"
payment_status  = "ชำระบางส่วน"
paid_amount     = 300,000.00
balance         = 298,000.00
due_date        = 2025-11-12
paid_date       = NULL
```

#### 📌 กลุ่มเอกสาร
| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `invoice_number` | เลขที่ใบแจ้งหนี้ | INV-2025-001 |
| `receipt_number` | เลขที่ใบเสร็จ | REC-2025-001 |

#### 📌 กลุ่มสถานะและการอนุมัติ
| คอลัมน์ | ความหมาย | ค่าที่เป็นไปได้ |
|---------|----------|----------------|
| `sale_status` | สถานะการขาย | รอยืนยัน, ยืนยันแล้ว, เสร็จสิ้น, ยกเลิก |
| `created_by` | ผู้บันทึก | 1 (user_id) |
| `approved_by` | ผู้อนุมัติ | 1 (user_id) |
| `approved_at` | วันที่อนุมัติ | 2025-10-12 10:30:00 |

#### ❌ คอลัมน์ที่ลบออก (ไม่จำเป็น)
- `delivery_date` - วันที่ส่งสินค้า (นายหน้ามารับเอง)
- `delivery_time` - เวลาส่ง (นายหน้ามารับเอง)
- `vehicle_number` - ทะเบียนรถ (นายหน้ามารถเอง)
- `driver_name` - ชื่อคนขับ (นายหน้ามีคนขับเอง)
- `distance_km` - ระยะทาง (ไม่เกี่ยวกับเรา)

**เก็บไว้เฉพาะ:** `shipping_cost` (ค่าขนส่งที่คิดค่าบริการ)

---

### 3. ตาราง `payments` (ใหม่ - สร้างขึ้นมาใหม่)
**จุดประสงค์:** บันทึกประวัติการชำระเงินแต่ละครั้ง (1 ใบขายสามารถชำระได้หลายครั้ง)

| คอลัมน์ | ความหมาย | ตัวอย่าง |
|---------|----------|----------|
| `payment_number` | เลขที่การชำระ | PAY-2025-001 |
| `pig_sell_id` | รหัสการขาย | 1, 2, 3 |
| `payment_date` | วันที่ชำระ | 2025-10-15 |
| `amount` | จำนวนเงิน | 300,000.00 |
| `payment_method` | วิธีชำระ | เงินสด, โอนเงิน |
| `reference_number` | เลขที่อ้างอิง | 1234567890 |
| `bank_name` | ธนาคาร | ธนาคารกรุงเทพ |
| `receipt_file` | ไฟล์หลักฐาน | cloudinary_url |
| `recorded_by` | ผู้บันทึก | 1 (user_id) |

**ตัวอย่างการใช้งาน:**

ขายมูลค่า 598,000 บาท - ชำระ 3 งวด:

| งวดที่ | วันที่ | จำนวน | วิธีชำระ | เลขอ้างอิง |
|--------|--------|--------|----------|-----------|
| 1 | 2025-10-15 | 200,000 | โอนเงิน | TX20251015001 |
| 2 | 2025-10-30 | 200,000 | โอนเงิน | TX20251030002 |
| 3 | 2025-11-10 | 198,000 | โอนเงิน | TX20251110003 |

---

## 🖥️ สิ่งที่เปลี่ยนแปลงในหน้าจอ (View)

### 1. ตารางแสดงรายการขาย

#### ก่อนอัปเดต (11 คอลัมน์):
```
วันที่ | ฟาร์ม | รุ่น | ประเภท | จำนวน | น้ำหนัก | ราคา/kg | ราคารวม | ผู้ซื้อ | สถานะ | จัดการ
```

#### หลังอัปเดต (10 คอลัมน์):
```
เลขที่ | วันที่ขาย | ลูกค้า | ฟาร์ม | รุ่น | จำนวน | น้ำหนัก | ราคาสุทธิ | สถานะชำระ | จัดการ
```

#### สิ่งที่เปลี่ยน:
✅ **เพิ่ม:**
- **เลขที่** - แสดง `sale_number` (SELL-2025-001)
- **ลูกค้า** - แสดงชื่อลูกค้าจาก `customers` table
- **ราคาสุทธิ** - แสดง `net_total` พร้อมรายละเอียดส่วนลดและค่าขนส่ง
- **สถานะชำระ** - Badge สี: รอชำระ(เทา), ชำระบางส่วน(เหลือง), ชำระแล้ว(เขียว), เกินกำหนด(แดง)

❌ **ลบ:**
- **ประเภท** - (ไม่จำเป็น)
- **ราคา/kg** - (ย้ายไปใน modal รายละเอียด)
- **ผู้ซื้อ** - (เปลี่ยนเป็น "ลูกค้า" แทน)

---

### 2. การแสดงน้ำหนัก

#### แสดงแบบอัจฉริยะ:
```blade
@if($sell->actual_weight)
    {{ number_format($sell->actual_weight, 2) }}
    (ชั่งจริง)
@else
    {{ number_format($sell->total_weight, 2) }}
@endif
```

**ตัวอย่างการแสดงผล:**
- มีน้ำหนักจริง: `5,450.00 (ชั่งจริง)`
- ยังไม่ได้ชั่ง: `5,500.00`

---

### 3. การแสดงราคาสุทธิ

```blade
598,000.00
ส่วนลด: 5,000.00
ค่าขนส่ง: 3,000.00
```

---

### 4. การแสดงสถานะชำระเงิน

| สถานะ | Badge | ข้อมูลเพิ่มเติม |
|-------|-------|-----------------|
| รอชำระ | 🔘 เทา | วันครบกำหนด: 12/11/2025 |
| ชำระบางส่วน | 🟡 เหลือง | คงเหลือ: 298,000.00 |
| ชำระแล้ว | 🟢 เขียว | - |
| เกินกำหนด | 🔴 แดง | - |

---

### 5. ปุ่มจัดการ

#### ก่อนอัปเดต:
```
[อัปโหลดสลิป] [ดูสลิป] [ยกเลิก]
```

#### หลังอัปเดต:
```
[👁️ ดู] [💰 ชำระ] [❌ ยกเลิก]
```

**อธิบาย:**
- **ดู** - เปิด Modal แสดงรายละเอียดครบถ้วน
- **ชำระ** - บันทึกการชำระเงิน (แสดงเฉพาะรายการที่ยังไม่ชำระครบ)
- **ยกเลิก** - ยกเลิกการขาย

---

### 6. Modal รายละเอียดการขาย (ใหม่)

แบ่งเป็น 3 ส่วน:

#### 📋 ส่วนที่ 1: ข้อมูลการขาย
```
เลขที่:        SELL-2025-001
วันที่ขาย:     12/10/2025
ลูกค้า:        บริษัท สมบูรณ์เนื้อสด จำกัด
ฟาร์ม:         ฟาร์มบ้านสวน
รุ่น:          BATCH-2024-001
```

#### 💰 ส่วนที่ 2: รายละเอียดราคา
```
จำนวน:         50 ตัว
น้ำหนัก:       5,450.00 kg
ราคา/kg:       110.00 บาท
ราคารวม:       600,000.00 บาท
ส่วนลด:        5,000.00 บาท
ค่าขนส่ง:      3,000.00 บาท
━━━━━━━━━━━━━━━━━━━━━━━━━━
ราคาสุทธิ:     598,000.00 บาท
```

#### 💳 ส่วนที่ 3: การชำระเงิน
```
วิธีชำระ:      โอนเงิน
สถานะ:         ชำระบางส่วน
ยอดที่ชำระแล้ว: 300,000.00 บาท
คงเหลือ:       298,000.00 บาท
```

---

### 7. Modal บันทึกการชำระเงิน (อัปเดต)

#### ฟอร์มชำระเงิน:
```
ยอดที่ต้องชำระ:      298,000.00 บาท (readonly)
จำนวนเงินที่ชำระ:     [input] (สามารถชำระบางส่วนได้)
วิธีชำระเงิน:        [dropdown: เงินสด / โอนเงิน]
อัปโหลดหลักฐาน:     [file upload] (ถ้ามี)
```

**ตัวอย่างการใช้งาน:**

**ชำระเต็มจำนวน:**
```
จำนวนเงินที่ชำระ: 298,000.00
วิธีชำระ: โอนเงิน
→ ผลลัพธ์: payment_status = "ชำระแล้ว", balance = 0
```

**ชำระบางส่วน:**
```
จำนวนเงินที่ชำระ: 100,000.00
วิธีชำระ: โอนเงิน
→ ผลลัพธ์: payment_status = "ชำระบางส่วน", balance = 198,000.00
```

---

## 🔄 การทำงานของระบบ (Workflow)

### สถานการณ์ที่ 1: ขายเงินสดทันที

```
1. เจ้าของฟาร์มกด "บันทึกการขายใหม่"
2. เลือก: ฟาร์ม, รุ่น, วันที่, จำนวน, น้ำหนัก, ราคา
3. เลือก: payment_term = "เงินสด"
4. ระบบคำนวณ net_total อัตโนมัติ
5. กด "บันทึก"
→ สร้างรายการขาย + ตั้งค่า payment_status = "ชำระแล้ว"
```

---

### สถานการณ์ที่ 2: ขายให้นายหน้าเครดิต 30 วัน

```
1. เจ้าของฟาร์มกด "บันทึกการขายใหม่"
2. เลือก: customer = "บริษัท ABC"
3. กรอก: จำนวน 50 ตัว, น้ำหนัก 5,500 kg
4. ระบบดึงราคา CPF: 110 บาท/kg
5. คำนวณ: total_price = 605,000
6. ใส่: ส่วนลด 5,000, ค่าขนส่ง 3,000
7. net_total = 603,000 บาท
8. เลือก: payment_term = "เครดิต 30 วัน"
9. กด "บันทึก"

→ ระบบสร้าง:
   - sale_number = SELL-2025-001
   - payment_status = "รอชำระ"
   - balance = 603,000
   - due_date = 2025-11-12 (วันนี้ + 30 วัน)
   
→ อัปเดตลูกค้า:
   - total_outstanding += 603,000
   - last_purchase_date = 2025-10-12
```

---

### สถานการณ์ที่ 3: ลูกค้าชำระเงินบางส่วน

```
วันที่ 15/10/2025 - ลูกค้าโอนเงินมา 300,000 บาท

1. เจ้าของฟาร์มเปิดรายการขาย SELL-2025-001
2. กดปุ่ม "💰 ชำระ"
3. กรอก:
   - จำนวน: 300,000
   - วิธีชำระ: โอนเงิน
   - อัปโหลดสลิป: slip.jpg
4. กด "บันทึก"

→ ระบบสร้างใน payments table:
   - payment_number = PAY-2025-001
   - amount = 300,000
   
→ อัปเดต pig_sells:
   - paid_amount = 300,000
   - balance = 303,000
   - payment_status = "ชำระบางส่วน"
   
→ อัปเดต customers:
   - total_outstanding = 303,000
```

---

### สถานการณ์ที่ 4: ลูกค้าชำระครบ

```
วันที่ 10/11/2025 - ลูกค้าชำระเงินที่เหลือ 303,000 บาท

1. กดปุ่ม "💰 ชำระ" อีกครั้ง
2. กรอก:
   - จำนวน: 303,000
   - วิธีชำระ: โอนเงิน
3. กด "บันทึก"

→ ระบบสร้างใน payments table:
   - payment_number = PAY-2025-002
   - amount = 303,000
   
→ อัปเดต pig_sells:
   - paid_amount = 603,000 (300,000 + 303,000)
   - balance = 0
   - payment_status = "ชำระแล้ว"
   - paid_date = 2025-11-10
   
→ อัปเดต customers:
   - total_outstanding = 0
   - total_purchased += 603,000
```

---

## 📱 ตัวอย่างหน้าจอจริง

### หน้าตารางแสดงรายการ:

```
┌────────────────────────────────────────────────────────────────────────────────┐
│  เลขที่         วันที่      ลูกค้า              ฟาร์ม    รุ่น    จำนวน  น้ำหนัก    │
├────────────────────────────────────────────────────────────────────────────────┤
│  SELL-2025-001  12/10/25   บจก.สมบูรณ์        บ้านสวน  B-001   50     5,450   │
│                                                                   (ชั่งจริง)    │
│                            ราคาสุทธิ           สถานะชำระ         จัดการ        │
│                            598,000.00          [ชำระบางส่วน]    [👁️][💰][❌]  │
│                            ส่วนลด: 5,000       คงเหลือ: 298,000                 │
│                            ค่าขนส่ง: 3,000                                      │
├────────────────────────────────────────────────────────────────────────────────┤
│  SELL-2025-002  11/10/25   บจก.ไทยรุ่งเรือง   นาใหม่   B-002   30     3,300   │
│                            495,000.00          [ชำระแล้ว]       [👁️][❌]      │
└────────────────────────────────────────────────────────────────────────────────┘
```

---

## 🎨 Badge สีตามสถานะ

| สถานะ | CSS Class | สีที่แสดง | เมื่อไหร่ |
|-------|-----------|-----------|-----------|
| รอชำระ | `badge bg-secondary` | เทา | paid_amount = 0 |
| ชำระบางส่วน | `badge bg-warning` | เหลือง | 0 < paid_amount < net_total |
| ชำระแล้ว | `badge bg-success` | เขียว | paid_amount = net_total |
| เกินกำหนด | `badge bg-danger` | แดง | balance > 0 AND due_date < วันนี้ |

---

## 🔢 ตัวอย่างการคำนวณ

### สูตรคำนวณราคาสุทธิ:
```php
$net_total = $total_price - $discount + $shipping_cost;
```

### สูตรคำนวณยอดคงเหลือ:
```php
$balance = $net_total - $paid_amount;
```

### สูตรคำนวณน้ำหนักเฉลี่ย:
```php
$avg_weight_per_pig = $actual_weight / $quantity;
```

### สูตรคำนวณวันครบกำหนด:
```php
// ถ้าเครดิต 30 วัน
$due_date = Carbon::parse($sell_date)->addDays(30);
```

---

## ⚠️ สิ่งที่ต้องทำต่อ

### 1. อัปเดต Controller (PigSellController.php)
- [ ] เพิ่ม `->with('customer')` ใน index() เพื่อ eager load
- [ ] อัปเดต validation rules ใน create()
- [ ] เพิ่มการคำนวณ net_total, balance, due_date
- [ ] สร้าง sale_number อัตโนมัติ
- [ ] จัดการ customer_id

### 2. อัปเดต Create Modal
- [ ] เพิ่ม dropdown เลือกลูกค้า (ใช้ Choices.js)
- [ ] เพิ่มฟิลด์ estimated_weight, actual_weight
- [ ] เพิ่มฟิลด์ discount, shipping_cost
- [ ] แสดง net_total แบบ real-time calculation
- [ ] เพิ่มฟิลด์ payment_method, payment_term

### 3. สร้างหน้าจัดการลูกค้า
- [ ] หน้า CRUD ลูกค้า
- [ ] แสดงประวัติการซื้อของลูกค้า
- [ ] แสดงยอดค้างชำระ
- [ ] เช็ควงเงินเครดิต

### 4. สร้างหน้าติดตามการชำระเงิน
- [ ] รายงานลูกค้าค้างชำระ
- [ ] รายงานใกล้ครบกำหนด
- [ ] รายงานเกินกำหนด
- [ ] ประวัติการชำระทั้งหมด

### 5. อัปเดต Export (CSV/PDF)
- [ ] เพิ่มคอลัมน์ใหม่ในไฟล์ export
- [ ] แสดงข้อมูลลูกค้า
- [ ] แสดง net_total, discount, shipping_cost

---

## 📝 สรุป

### สิ่งที่ได้:
✅ ระบบจัดการลูกค้าแบบมืออาชีพ  
✅ ติดตามการให้เครดิตและยอดค้างชำระ  
✅ บันทึกการชำระเงินแบบ multi-payment  
✅ คำนวณราคาสุทธิพร้อมส่วนลดและค่าขนส่ง  
✅ แสดงน้ำหนักจริงและประมาณการ  
✅ Integration กับราคา CPF  
✅ สร้างเลขที่อ้างอิงอัตโนมัติ  

### ผลที่ตามมา:
💼 เหมาะกับธุรกิจขายส่งให้นายหน้า  
📊 ติดตามการเงินได้ชัดเจน  
🔐 มีระบบอนุมัติการขาย  
📈 วิเคราะห์ลูกค้าและยอดขายได้  

---

**วันที่สร้างเอกสาร:** 12 ตุลาคม 2025  
**ผู้สร้าง:** GitHub Copilot  
**เวอร์ชัน:** 1.0
