# 🔒 Batch "เสร็จสิ้น" - คืนที่ว่างและป้องกันการบันทึก

## 📌 สรุปความต้องการ

เมื่อรุ่นหมู (Batch) เปลี่ยนสถานะเป็น **"เสร็จสิ้น"**:
1. ✅ **คืนที่ว่างในเล้า** → set `current_quantity = 0` ใน `batch_pen_allocations`
2. ✅ **ป้องกันการบันทึกข้อมูลใหม่** → ไม่ให้บันทึก Dairy, PigSell ในรุ่นที่เสร็จสิ้นแล้ว

---

## 🎯 เหตุผล (Business Logic)

### **1. ทำไมต้องคืน current_quantity?**

```
สถานการณ์จริงในฟาร์ม:
────────────────────────
เล้า A มี capacity 200 ตัว

▶️ วันที่ 1: รับหมูรุ่น 001 เข้า 150 ตัว
   - allocated_pigs = 150
   - current_quantity = 150
   - ที่ว่างในเล้า = 200 - 150 = 50 ตัว

▶️ วันที่ 90: ขายหมูไป 100 ตัว
   - allocated_pigs = 150 (ไม่เปลี่ยน)
   - current_quantity = 50
   - ที่ว่างในเล้า = 200 - 50 = 150 ตัว ✅

▶️ วันที่ 120: ขายหมูที่เหลือหมด (50 ตัว)
   - allocated_pigs = 150 (ไม่เปลี่ยน)
   - current_quantity = 0
   - ที่ว่างในเล้า = 200 - 0 = 200 ตัว ✅
   - สถานะรุ่น → "เสร็จสิ้น"

🎯 ผล:
   - เล้าว่างเต็ม 200 ตัว พร้อมรับหมูรุ่นใหม่
   - ไม่ต้องสร้างเล้าใหม่
```

**ถ้าไม่คืน current_quantity:**
```
❌ ที่ว่างในเล้า = 200 - 150 = 50 ตัว
   → เล้ายังมีหมู allocated_pigs = 150 ติดอยู่
   → ไม่สามารถใช้พื้นที่เต็มได้
   → ต้องสร้างเล้าใหม่ (ต้นทุนเพิ่ม)
```

---

### **2. ทำไมต้องป้องกันการบันทึก?**

```
เหตุผลหลัก:
────────────
1. ความสมบูรณ์ของข้อมูล (Data Integrity)
   - รุ่นเสร็จสิ้น = ไม่มีหมูแล้ว (current_quantity = 0)
   - ถ้ายังบันทึกได้ → ข้อมูลไม่สอดคล้อง

2. การบัญชี/การเงิน
   - รุ่นเสร็จสิ้น = ปิดบัญชีแล้ว
   - ถ้ายังบันทึกได้ → บัญชีไม่ถูกต้อง

3. การจัดการฟาร์ม
   - รุ่นเสร็จสิ้น = เล้าว่างแล้ว
   - ถ้ายังบันทึกได้ → สับสน (มีหมูหรือไม่?)

ตัวอย่างปัญหา:
────────────
สถานการณ์: รุ่น 001 เสร็จสิ้นแล้ว (current_quantity = 0)

❌ ถ้าไม่ป้องกัน:
   1. เจ้าหน้าที่พิมพ์ผิด batch_id
   2. บันทึก "หมูตาย 5 ตัว" ในรุ่น 001
   3. current_quantity = 0 - 5 = -5 ← ไม่สมเหตุสมผล!
   4. ระบบ error หรือข้อมูลเพี้ยน

✅ ถ้าป้องกัน:
   1. เจ้าหน้าที่พิมพ์ผิด batch_id
   2. ระบบแจ้ง: "❌ ไม่สามารถบันทึกได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว"
   3. เจ้าหน้าที่แก้ไข batch_id ให้ถูกต้อง
   4. ข้อมูลถูกต้อง ✅
```

---

## 🔧 การแก้ไขที่ทำ

### **1. BatchController.php - คืนที่ว่างเมื่อเสร็จสิ้น**

```php
public function updateBatch(Request $request, $id)
{
    DB::beginTransaction();
    try {
        $batch = Batch::findOrFail($id);

        $oldStatus = $batch->status;
        $newStatus = $request->status;

        if ($oldStatus != 'เสร็จสิ้น' && $newStatus == 'เสร็จสิ้น') {
            // 1. Set end_date
            $batch->end_date = now();

            // 2. คืนที่ว่างในเล้า (set current_quantity = 0)
            BatchPenAllocation::where('batch_id', $id)
                ->update(['current_quantity' => 0]);

            // 3. อัปเดต batch current_quantity
            $batch->current_quantity = 0;
        }

        $batch->status = $newStatus;
        $batch->update($validated);

        DB::commit();
        return redirect()->route('batches.index')
            ->with('success', 'แก้ไข Batch สำเร็จ (คืนที่ว่างในเล้าแล้ว)');
    } catch (\Exception $e) {
        DB::rollBack();
        return redirect()->back()->with('error', 'เกิดข้อผิดพลาด: ' . $e->getMessage());
    }
}
```

**ผลลัพธ์:**
```sql
-- ก่อนเปลี่ยนสถานะ (รุ่น 001 กำลังเลี้ยง)
batch_pen_allocations:
  batch_id=1, pen_id=1, allocated_pigs=100, current_quantity=20

batches:
  id=1, status='กำลังเลี้ยง', current_quantity=20

-- หลังเปลี่ยนเป็น "เสร็จสิ้น"
batch_pen_allocations:
  batch_id=1, pen_id=1, allocated_pigs=100, current_quantity=0 ← คืนแล้ว!

batches:
  id=1, status='เสร็จสิ้น', current_quantity=0, end_date='2025-10-12'

-- เล้ามีที่ว่าง
เล้า capacity: 200
occupied (current_quantity): 0
remaining: 200 - 0 = 200 ตัว ✅ พร้อมรับหมูรุ่นใหม่
```

---

### **2. DairyController.php - ป้องกันบันทึกในรุ่นเสร็จสิ้น**

```php
public function uploadDairy(Request $request)
{
    try {
        // ตรวจสอบสถานะ batch
        $batch = Batch::find($request->batch_id);
        if (!$batch) {
            return redirect()->back()->with('error', '❌ ไม่พบข้อมูลรุ่น');
        }

        if ($batch->status === 'เสร็จสิ้น') {
            return redirect()->back()
                ->with('error', '❌ ไม่สามารถบันทึกข้อมูลได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว');
        }

        // ... ส่วนที่เหลือเหมือนเดิม
    }
}
```

**ตัวอย่างการใช้งาน:**
```
สถานการณ์ 1: บันทึก Dairy ในรุ่นที่กำลังเลี้ยง
────────────────────────────────────────────────
เลือกรุ่น: BATCH-2024-001 (สถานะ: กำลังเลี้ยง)
บันทึก: หมูตาย 3 ตัว
ผล: ✅ บันทึกสำเร็จ

สถานการณ์ 2: บันทึก Dairy ในรุ่นที่เสร็จสิ้น
────────────────────────────────────────────────
เลือกรุ่น: BATCH-2024-001 (สถานะ: เสร็จสิ้น)
บันทึก: หมูตาย 3 ตัว
ผล: ❌ ไม่สามารถบันทึกข้อมูลได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว
```

---

### **3. PigSellController.php - ป้องกันขายในรุ่นเสร็จสิ้น**

```php
public function create(Request $request)
{
    DB::beginTransaction();
    try {
        $validated = $request->validate([...]);

        // ตรวจสอบสถานะ batch
        $batch = Batch::find($validated['batch_id']);
        if (!$batch) {
            throw new \Exception('❌ ไม่พบข้อมูลรุ่น');
        }

        if ($batch->status === 'เสร็จสิ้น') {
            throw new \Exception('❌ ไม่สามารถบันทึกการขายได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว');
        }

        // ... ส่วนที่เหลือเหมือนเดิม
    }
}
```

**ตัวอย่างการใช้งาน:**
```
สถานการณ์ 1: ขายหมูในรุ่นที่กำลังเลี้ยง
────────────────────────────────────────
เลือกรุ่น: BATCH-2024-001 (สถานะ: กำลังเลี้ยง)
ขาย: 30 ตัว
ผล: ✅ บันทึกสำเร็จ

สถานการณ์ 2: ขายหมูในรุ่นที่เสร็จสิ้น
────────────────────────────────────────
เลือกรุ่น: BATCH-2024-001 (สถานะ: เสร็จสิ้น)
ขาย: 30 ตัว
ผล: ❌ ไม่สามารถบันทึกการขายได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว
```

---

## 📊 สรุปการเปลี่ยนแปลง

| เหตุการณ์ | ก่อนแก้ไข | หลังแก้ไข |
|-----------|----------|----------|
| **เปลี่ยนสถานะเป็น "เสร็จสิ้น"** | ❌ set end_date อย่างเดียว | ✅ set end_date + คืน current_quantity = 0 |
| **บันทึก Dairy ในรุ่นเสร็จสิ้น** | ⚠️ บันทึกได้ (ผิด) | ✅ แสดง Error ป้องกัน |
| **ขายหมูในรุ่นเสร็จสิ้น** | ⚠️ ขายได้ (ผิด) | ✅ แสดง Error ป้องกัน |
| **รับหมูเข้าในรุ่นเสร็จสิ้น** | ⚠️ รับได้ (ผิด) | ✅ แสดง Error ป้องกัน |
| **ที่ว่างในเล้าหลังรุ่นเสร็จสิ้น** | ❌ ยังนับ allocated_pigs | ✅ คืนเต็ม (current_quantity = 0) |

---

## 🔄 Workflow ที่ถูกต้อง

### **1. รุ่นปกติ (กำลังเลี้ยง)**
```
Day 1: รับหมู 150 ตัว
  └─ allocated_pigs = 150
  └─ current_quantity = 150
  └─ status = 'กำลังเลี้ยง' ✅

Day 60: ขายหมู 50 ตัว
  └─ current_quantity = 100
  └─ status = 'กำลังเลี้ยง' ✅

Day 90: หมูตาย 5 ตัว
  └─ current_quantity = 95
  └─ status = 'กำลังเลี้ยง' ✅

Day 120: ขายหมูหมด (95 ตัว)
  └─ current_quantity = 0
  └─ status = 'กำลังเลี้ยง' ✅
```

### **2. เปลี่ยนสถานะเป็นเสร็จสิ้น**
```
ผู้จัดการคลิก: สถานะ → "เสร็จสิ้น" → บันทึก

ระบบทำ:
  ✅ set end_date = now()
  ✅ set current_quantity = 0 (ทุก pen)
  ✅ set batch.current_quantity = 0
  ✅ คืนที่ว่างในเล้าทั้งหมด

ผล:
  - เล้าว่างเต็ม พร้อมรับหมูรุ่นใหม่
  - ไม่สามารถบันทึก Dairy/Sell ได้อีก
```

### **3. พยายามบันทึกข้อมูลในรุ่นเสร็จสิ้น**
```
เจ้าหน้าที่พยายามบันทึก Dairy:
  ❌ ระบบแสดง: "ไม่สามารถบันทึกข้อมูลได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว"

เจ้าหน้าที่พยายามขายหมู:
  ❌ ระบบแสดง: "ไม่สามารถบันทึกการขายได้ เพราะรุ่นนี้เสร็จสิ้นแล้ว"

→ เจ้าหน้าที่เลือกรุ่นใหม่ที่กำลังเลี้ยงแทน
```

---

## ⚠️ ข้อควรระวัง

### **1. ข้อมูลเก่าก่อนแก้ไข**
```
ถ้ามีรุ่นที่เสร็จสิ้นไปแล้ว แต่ยัง current_quantity > 0:
  → ต้อง manual update ให้ current_quantity = 0

SQL:
UPDATE batch_pen_allocations
SET current_quantity = 0
WHERE batch_id IN (
  SELECT id FROM batches WHERE status = 'เสร็จสิ้น'
);

UPDATE batches
SET current_quantity = 0
WHERE status = 'เสร็จสิ้น';
```

### **2. การเปลี่ยนสถานะกลับ**
```
ถ้าต้องเปลี่ยนจาก "เสร็จสิ้น" → "กำลังเลี้ยง":
  ⚠️ current_quantity ยัง = 0
  → ต้อง manual update กลับ
  → หรือป้องกันไม่ให้เปลี่ยนกลับ (แนะนำ)
```

### **3. การลบ Batch**
```
ถ้าลบ batch ที่เสร็จสิ้น:
  ✅ batch_pen_allocations ถูกลบตาม (CASCADE)
  ✅ current_quantity = 0 อยู่แล้ว
  → ไม่มีปัญหา
```

---

## ✅ สรุป

### **ประโยชน์ที่ได้:**
1. ✅ **ใช้พื้นที่เล้าอย่างมีประสิทธิภาพ** - คืนที่ว่างทันทีเมื่อรุ่นเสร็จสิ้น
2. ✅ **ป้องกันข้อมูลผิดพลาด** - ไม่ให้บันทึกในรุ่นที่ปิดไปแล้ว
3. ✅ **บัญชีถูกต้อง** - รุ่นเสร็จสิ้น = ปิดบัญชีแล้ว
4. ✅ **จัดการง่าย** - รู้ชัดเจนว่ารุ่นไหนเสร็จ/ยังไม่เสร็จ

### **ไฟล์ที่แก้แล้ว:**
- ✅ `app/Http/Controllers/BatchController.php` - คืน current_quantity
- ✅ `app/Http/Controllers/DairyController.php` - ป้องกันบันทึก Dairy (Feed/Medicine/Death)
- ✅ `app/Http/Controllers/PigSellController.php` - ป้องกันบันทึก Sell
- ✅ `app/Http/Controllers/PigEntryController.php` - ป้องกันบันทึกรับหมูเข้า

---

**วันที่อัปเดต:** 12 ตุลาคม 2025
**ผู้อัปเดต:** GitHub Copilot
**เวอร์ชัน:** 1.0
