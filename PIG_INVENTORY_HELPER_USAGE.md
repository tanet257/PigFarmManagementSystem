# ЁЯУж PigInventoryHelper - р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ

## ЁЯОп р╕Ир╕╕р╕Фр╕Ыр╕гр╕░р╕кр╕Зр╕Др╣М

Helper р╕Щр╕╡р╣Йр╕Чр╕│р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣Ир╕Ир╕▒р╕Фр╕Бр╕▓р╕гр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Гр╕Щр╕гр╕░р╕Ър╕Ър╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╣Бр╕ер╕░р╕кр╕нр╕Фр╕Др╕ер╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Чр╕▒р╣Йр╕З 2 р╕Хр╕▓р╕гр╕▓р╕З:
1. **`batch_pen_allocations`** - р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Гр╕Щр╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б
2. **`batches`** - р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕гр╕зр╕бр╕Вр╕нр╕Зр╕гр╕╕р╣Ир╕Щ

---

## ЁЯУК р╣Вр╕Др╕гр╕Зр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕е

### р╕Хр╕▓р╕гр╕▓р╕З `batches`
```
id | batch_code | total_pig_amount | current_quantity
1  | BATCH-001  | 500             | 450
```
- **`total_pig_amount`** = р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╕Лр╕╖р╣Йр╕нр╣Ар╕Вр╣Йр╕▓р╕бр╕▓ (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)
- **`current_quantity`** = р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╣Ар╕лр╕ер╕╖р╕нр╕нр╕вр╕╣р╣Ир╕Ыр╕▒р╕Ир╕Ир╕╕р╕Ър╕▒р╕Щ (р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Хр╕▓р╕бр╕Бр╕▓р╕гр╕Вр╕▓р╕в/р╕Хр╕▓р╕в)

### р╕Хр╕▓р╕гр╕▓р╕З `batch_pen_allocations`
```
id | batch_id | barn_id | pen_id | pig_amount | current_quantity
1  | 1        | 1       | 1      | 100        | 95
2  | 1        | 1       | 2      | 150        | 145
3  | 1        | 2       | 3      | 250        | 210
```
- **`pig_amount`** = р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╣Гр╕кр╣Ир╣Ар╕Вр╣Йр╕▓р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б (р╣Др╕бр╣Ир╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щ)
- **`current_quantity`** = р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╣Ар╕лр╕ер╕╖р╕нр╕нр╕вр╕╣р╣Ир╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б (р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Хр╕▓р╕бр╕Бр╕▓р╕гр╕Вр╕▓р╕в/р╕Хр╕▓р╕в)

---

## ЁЯЫая╕П р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕Чр╕╡р╣Ир╕бр╕╡р╣Гр╕лр╣Йр╣Гр╕Кр╣Й

### 1. `addPigs()` - р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╣Ар╕Вр╣Йр╕▓р╕гр╕░р╕Ър╕Ъ

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕Лр╕╖р╣Йр╕нр╕лр╕бр╕╣р╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Гр╕лр╕бр╣И

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ
- `$barnId` (int) - р╕гр╕лр╕▒р╕кр╣Ар╕ер╣Йр╕▓
- `$penId` (int) - р╕гр╕лр╕▒р╕кр╕Др╕нр╕Б
- `$quantity` (int) - р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕б

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

// р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣ 50 р╕Хр╕▒р╕зр╣Ар╕Вр╣Йр╕▓р╣Ар╕ер╣Йр╕▓ 1 р╕Др╕нр╕Б 1 р╕Вр╕нр╕Зр╕гр╕╕р╣Ир╕Щ 1
$result = PigInventoryHelper::addPigs(
    batchId: 1,
    barnId: 1,
    penId: 1,
    quantity: 50
);

if ($result['success']) {
    echo $result['message']; // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Ар╕Фр╕┤р╕б (50 р╕Хр╕▒р╕з)
    // р╕лр╕гр╕╖р╕н тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Гр╕лр╕бр╣И (50 р╕Хр╕▒р╕з)
} else {
    echo $result['message']; // тЭМ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф: ...
}
```

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:**
```php
[
    'success' => true,
    'message' => 'тЬЕ р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Гр╕лр╕бр╣И (50 р╕Хр╕▒р╕з)',
    'data' => [
        'quantity_added' => 50,
        'allocation_id' => 4,
        'batch' => [
            'total_pig_amount' => 550,
            'current_quantity' => 500
        ]
    ]
]
```

---

### 2. `reducePigInventory()` - р╕ер╕Фр╕лр╕бр╕╣р╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕Вр╕▓р╕вр╕лр╕бр╕╣, р╕лр╕бр╕╣р╕Хр╕▓р╕в, р╕Др╕▒р╕Фр╕лр╕бр╕╣р╕Чр╕┤р╣Йр╕З

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ
- `$penId` (int) - р╕гр╕лр╕▒р╕кр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б
- `$quantity` (int) - р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕ер╕Ф
- `$reason` (string) - р╣Ар╕лр╕Хр╕╕р╕Ьр╕е: `'sale'`, `'death'`, `'culling'`

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

// р╕Вр╕▓р╕вр╕лр╕бр╕╣ 30 р╕Хр╕▒р╕зр╕Ир╕▓р╕Бр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б 1 р╕Вр╕нр╕Зр╕гр╕╕р╣Ир╕Щ 1
$result = PigInventoryHelper::reducePigInventory(
    batchId: 1,
    penId: 1,
    quantity: 30,
    reason: 'sale'
);

if ($result['success']) {
    echo $result['message']; // тЬЕ р╕ер╕Фр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в (30 р╕Хр╕▒р╕з)
    
    $data = $result['data'];
    echo "р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Ар╕лр╕ер╕╖р╕н: " . $data['pen_allocation']['remaining'] . " р╕Хр╕▒р╕з";
    echo "р╕гр╕╕р╣Ир╕Щр╣Ар╕лр╕ер╕╖р╕н: " . $data['batch']['remaining'] . " р╕Хр╕▒р╕з";
} else {
    echo $result['message']; // тЭМ р╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н
}
```

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕кр╕│р╣Ар╕гр╣Зр╕И:**
```php
[
    'success' => true,
    'message' => 'тЬЕ р╕ер╕Фр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в (30 р╕Хр╕▒р╕з)',
    'data' => [
        'reason' => 'sale',
        'quantity_reduced' => 30,
        'pen_allocation' => [
            'before' => 100,
            'after' => 70,
            'remaining' => 70
        ],
        'batch' => [
            'before' => 500,
            'after' => 470,
            'remaining' => 470
        ]
    ]
]
```

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕ер╣Йр╕бр╣Ар╕лр╕ер╕з (р╕лр╕бр╕╣р╣Др╕бр╣Ир╕Юр╕н):**
```php
[
    'success' => false,
    'message' => 'тЭМ р╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н (р╕бр╕╡р╕нр╕вр╕╣р╣И 70 р╕Хр╕▒р╕з р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г 100 р╕Хр╕▒р╕з)',
    'data' => [
        'available' => 70,
        'requested' => 100,
        'shortage' => 30
    ]
]
```

---

### 3. `increasePigInventory()` - р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╕Бр╕ер╕▒р╕Ър╣Ар╕Вр╣Йр╕▓р╕гр╕░р╕Ър╕Ъ

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ
- `$penId` (int) - р╕гр╕лр╕▒р╕кр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б
- `$quantity` (int) - р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╣Ар╕Юр╕┤р╣Ир╕бр╕Бр╕ер╕▒р╕Ъ

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

// р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в - р╕Др╕╖р╕Щр╕лр╕бр╕╣ 30 р╕Хр╕▒р╕зр╕Бр╕ер╕▒р╕Ър╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б 1
$result = PigInventoryHelper::increasePigInventory(
    batchId: 1,
    penId: 1,
    quantity: 30
);

if ($result['success']) {
    echo $result['message']; // тЬЕ р╣Ар╕Юр╕┤р╣Ир╕бр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Бр╕ер╕▒р╕Ър╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в (30 р╕Хр╕▒р╕з)
} else {
    echo $result['message']; // тЪая╕П р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Ир╕░р╣Ар╕Бр╕┤р╕Щр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ
}
```

---

### 4. `getPigsByBatch()` - р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕бр╕╣р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Вр╕нр╕Зр╕гр╕╕р╣Ир╕Щ

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╣р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕бр╕╣р╣Бр╕вр╕Бр╕Хр╕▓р╕бр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

$pigs = PigInventoryHelper::getPigsByBatch(1);

echo "р╕гр╕╕р╣Ир╕Щр╕Щр╕╡р╣Йр╕бр╕╡р╕лр╕бр╕╣р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: " . $pigs['summary']['total_pigs'] . " р╕Хр╕▒р╕з\n";
echo "р╣Ар╕лр╕ер╕╖р╕нр╕нр╕вр╕╣р╣И: " . $pigs['summary']['current_pigs'] . " р╕Хр╕▒р╕з\n";

foreach ($pigs['allocations'] as $allocation) {
    echo "р╣Ар╕ер╣Йр╕▓: {$allocation['barn_name']}, р╕Др╕нр╕Б: {$allocation['pen_name']}\n";
    echo "р╕бр╕╡р╕лр╕бр╕╣: {$allocation['current_quantity']} / {$allocation['pig_amount']} р╕Хр╕▒р╕з\n";
}
```

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:**
```php
[
    'batch_id' => 1,
    'batch_code' => 'BATCH-001',
    'allocations' => [
        [
            'allocation_id' => 1,
            'barn_id' => 1,
            'barn_name' => 'р╣Вр╕гр╕Зр╣Ар╕гр╕╖р╕нр╕Щ A',
            'pen_id' => 1,
            'pen_name' => 'р╕Др╕нр╕Б A1',
            'pig_amount' => 100,
            'current_quantity' => 70,
            'reduced' => 30
        ],
        // ...
    ],
    'summary' => [
        'total_pigs' => 500,
        'current_pigs' => 450,
        'total_reduced' => 50
    ]
]
```

---

### 5. `getPigsByPen()` - р╕Фр╕╢р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Ар╕Фр╕╡р╕вр╕з

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╣р╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Гр╕Фр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕лр╕Щр╕╢р╣Ир╕З

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ
- `$penId` (int) - р╕гр╕лр╕▒р╕кр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

$result = PigInventoryHelper::getPigsByPen(1, 1);

if ($result['success']) {
    $data = $result['data'];
    echo "р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕Щр╕╡р╣Йр╕бр╕╡р╕лр╕бр╕╣: {$data['current_quantity']} р╕Хр╕▒р╕з\n";
    echo "р╕Др╕зр╕▓р╕бр╕Ир╕╕: {$data['pen_capacity']} р╕Хр╕▒р╕з\n";
    echo "р╕зр╣Ир╕▓р╕З: {$data['available_space']} р╕Хр╕▒р╕з\n";
}
```

**р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣М:**
```php
[
    'success' => true,
    'data' => [
        'allocation_id' => 1,
        'batch_id' => 1,
        'barn_id' => 1,
        'pen_id' => 1,
        'pig_amount' => 100,
        'current_quantity' => 70,
        'pen_capacity' => 100,
        'available_space' => 30,
        'utilization_rate' => 70.0
    ]
]
```

---

### 6. `getAvailablePensByBatch()` - р╕Фр╕╣р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕Чр╕╡р╣Ир╕бр╕╡р╕Чр╕╡р╣Ир╕зр╣Ир╕▓р╕З

**р╣Гр╕Кр╣Йр╣Ар╕бр╕╖р╣Ир╕н:** р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕лр╕▓р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕Чр╕╡р╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╣Др╕Фр╣Й

**р╕Юр╕▓р╕гр╕▓р╕бр╕┤р╣Ар╕Хр╕нр╕гр╣М:**
- `$batchId` (int) - р╕гр╕лр╕▒р╕кр╕гр╕╕р╣Ир╕Щ
- `$requiredSpace` (int, optional) - р╕Ир╕│р╕Щр╕зр╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г

**р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ:**

```php
use App\Helpers\PigInventoryHelper;

// р╕лр╕▓р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕Чр╕╡р╣Ир╕бр╕╡р╕Чр╕╡р╣Ир╕зр╣Ир╕▓р╕Зр╕нр╕вр╣Ир╕▓р╕Зр╕Щр╣Йр╕нр╕в 50 р╕Хр╕▒р╕з
$pens = PigInventoryHelper::getAvailablePensByBatch(1, 50);

foreach ($pens as $pen) {
    echo "р╣Ар╕ер╣Йр╕▓: {$pen['barn_name']}, р╕Др╕нр╕Б: {$pen['pen_name']}\n";
    echo "р╕зр╣Ир╕▓р╕З: {$pen['available_space']} р╕Хр╕▒р╕з\n";
}
```

---

## ЁЯФД Workflow р╕Бр╕▓р╕гр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щр╕Ир╕гр╕┤р╕З

### р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣Мр╕Чр╕╡р╣И 1: р╕Лр╕╖р╣Йр╕нр╕лр╕бр╕╣р╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Гр╕лр╕бр╣И

```php
// р╣Гр╕Щ PigEntryController@upload_pig_entry_record

use App\Helpers\PigInventoryHelper;

// р╕зр╕Щр╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╣Ар╕Вр╣Йр╕▓р╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б
foreach ($pens as $pen) {
    $result = PigInventoryHelper::addPigs(
        batchId: $batch->id,
        barnId: $barn->id,
        penId: $pen->id,
        quantity: $allocateToPen
    );
    
    if (!$result['success']) {
        throw new Exception($result['message']);
    }
}
```

**р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Фр╕Вр╕╢р╣Йр╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤:**
1. тЬЕ р╕кр╕гр╣Йр╕▓р╕З/р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ `batch_pen_allocations`
2. тЬЕ р╕нр╕▒р╕Ыр╣Ар╕Фр╕Х `batches.total_pig_amount` р╣Бр╕ер╕░ `current_quantity`
3. тЬЕ р╣Гр╕Кр╣Й Transaction р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф

---

### р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣Мр╕Чр╕╡р╣И 2: р╕Вр╕▓р╕вр╕лр╕бр╕╣

```php
// р╣Гр╕Щ PigSellController@create

use App\Helpers\PigInventoryHelper;

// р╕ер╕Фр╕лр╕бр╕╣р╕Ир╕▓р╕Бр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╕Чр╕╡р╣Ир╣Ар╕ер╕╖р╕нр╕Б
$result = PigInventoryHelper::reducePigInventory(
    batchId: $batch->id,
    penId: $penId,
    quantity: $quantity,
    reason: 'sale'
);

if (!$result['success']) {
    return redirect()->back()->with('error', $result['message']);
}

// р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в
PigSell::create([
    'batch_id' => $batch->id,
    'pen_id' => $penId,
    'quantity' => $quantity,
    // ... р╕Яр╕┤р╕ер╕Фр╣Мр╕нр╕╖р╣Ир╕Щр╣Ж
]);
```

**р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Фр╕Вр╕╢р╣Йр╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤:**
1. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕лр╕бр╕╣р╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕нр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
2. тЬЕ р╕ер╕Ф `batch_pen_allocations.current_quantity`
3. тЬЕ р╕ер╕Ф `batches.current_quantity`
4. тЬЕ Return р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Ир╕│р╕Щр╕зр╕Щр╕Бр╣Ир╕нр╕Щ-р╕лр╕ер╕▒р╕З

---

### р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣Мр╕Чр╕╡р╣И 3: р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в

```php
// р╣Гр╕Щ PigSellController@cancel

use App\Helpers\PigInventoryHelper;

// р╣Ар╕Юр╕┤р╣Ир╕бр╕лр╕бр╕╣р╕Бр╕ер╕▒р╕Ър╣Ар╕Вр╣Йр╕▓р╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Б
$result = PigInventoryHelper::increasePigInventory(
    batchId: $sell->batch_id,
    penId: $sell->pen_id,
    quantity: $sell->quantity
);

if (!$result['success']) {
    return redirect()->back()->with('error', $result['message']);
}

// р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕кр╕Цр╕▓р╕Щр╕░
$sell->update(['sale_status' => 'р╕вр╕Бр╣Ар╕ер╕┤р╕Б']);
```

**р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣Ир╣Ар╕Бр╕┤р╕Фр╕Вр╕╢р╣Йр╕Щр╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤:**
1. тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б `batch_pen_allocations.current_quantity`
2. тЬЕ р╣Ар╕Юр╕┤р╣Ир╕б `batches.current_quantity`
3. тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╣Др╕бр╣Ир╣Гр╕лр╣Йр╣Ар╕Бр╕┤р╕Щр╕Ир╕│р╕Щр╕зр╕Щр╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щ

---

### р╕кр╕Цр╕▓р╕Щр╕Бр╕▓р╕гр╕Ур╣Мр╕Чр╕╡р╣И 4: р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕лр╕бр╕╣р╕Хр╕▓р╕в

```php
// р╣Гр╕Щ PigDeathController@create

use App\Helpers\PigInventoryHelper;

// р╕ер╕Фр╕лр╕бр╕╣р╕Ир╕▓р╕Бр╕гр╕░р╕Ър╕Ъ
$result = PigInventoryHelper::reducePigInventory(
    batchId: $batch->id,
    penId: $penId,
    quantity: $quantity,
    reason: 'death'
);

if (!$result['success']) {
    return redirect()->back()->with('error', $result['message']);
}

// р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Хр╕▓р╕в
PigDeath::create([
    'batch_id' => $batch->id,
    'pen_id' => $penId,
    'quantity' => $quantity,
    'death_date' => $deathDate,
    // ... р╕Яр╕┤р╕ер╕Фр╣Мр╕нр╕╖р╣Ир╕Щр╣Ж
]);
```

---

## тЪая╕П р╕Вр╣Йр╕нр╕Др╕зр╕гр╕гр╕░р╕зр╕▒р╕З

### 1. **р╕нр╕вр╣Ир╕▓р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╕Фр╣Йр╕зр╕вр╕Хр╕▒р╕зр╣Ар╕нр╕З**

тЭМ **р╕Ьр╕┤р╕Ф:**
```php
// р╕нр╕вр╣Ир╕▓р╕Чр╕│р╣Бр╕Ър╕Ър╕Щр╕╡р╣Й!
$batch = Batch::find(1);
$batch->current_quantity -= 30;
$batch->save();

DB::table('batch_pen_allocations')
    ->where('id', 1)
    ->update(['current_quantity' => DB::raw('current_quantity - 30')]);
```

тЬЕ **р╕Цр╕╣р╕Б:**
```php
// р╣Гр╕Кр╣Й Helper р╣Бр╕Чр╕Щ
PigInventoryHelper::reducePigInventory(
    batchId: 1,
    penId: 1,
    quantity: 30,
    reason: 'sale'
);
```

### 2. **р╣Ар╕Кр╣Зр╕Д success р╕Бр╣Ир╕нр╕Щр╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╣Ир╕н**

```php
$result = PigInventoryHelper::reducePigInventory(...);

if (!$result['success']) {
    // р╕Ир╕▒р╕Фр╕Бр╕▓р╕г error
    return redirect()->back()->with('error', $result['message']);
}

// р╕Фр╕│р╣Ар╕Щр╕┤р╕Щр╕Бр╕▓р╕гр╕Хр╣Ир╕н...
```

### 3. **р╣Гр╕Кр╣Й Transaction р╕Цр╣Йр╕▓р╕бр╕╡р╕лр╕ер╕▓р╕вр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щ**

```php
DB::beginTransaction();

try {
    // р╕ер╕Фр╕лр╕бр╕╣
    $result = PigInventoryHelper::reducePigInventory(...);
    if (!$result['success']) {
        throw new Exception($result['message']);
    }
    
    // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в
    PigSell::create([...]);
    
    // р╕Ър╕▒р╕Щр╕Чр╕╢р╕Бр╕Бр╕▓р╕гр╕Кр╕│р╕гр╕░р╣Ар╕Зр╕┤р╕Щ
    Payment::create([...]);
    
    DB::commit();
} catch (Exception $e) {
    DB::rollBack();
    return redirect()->back()->with('error', $e->getMessage());
}
```

---

## ЁЯзк р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Response

### Success Response
```php
[
    'success' => true,
    'message' => 'тЬЕ р╕ер╕Фр╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Ар╕гр╕╡р╕вр╕Ър╕гр╣Йр╕нр╕в (30 р╕Хр╕▒р╕з)',
    'data' => [
        'reason' => 'sale',
        'quantity_reduced' => 30,
        'pen_allocation' => [
            'before' => 100,
            'after' => 70,
            'remaining' => 70
        ],
        'batch' => [
            'before' => 500,
            'after' => 470,
            'remaining' => 470
        ]
    ]
]
```

### Error Response
```php
[
    'success' => false,
    'message' => 'тЭМ р╕лр╕бр╕╣р╣Гр╕Щр╣Ар╕ер╣Йр╕▓-р╕Др╕нр╕Бр╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н (р╕бр╕╡р╕нр╕вр╕╣р╣И 70 р╕Хр╕▒р╕з р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕г 100 р╕Хр╕▒р╕з)',
    'data' => [
        'available' => 70,
        'requested' => 100,
        'shortage' => 30
    ]
]
```

---

## ЁЯУЭ р╕кр╕гр╕╕р╕Ы

### тЬЕ р╕Вр╣Йр╕нр╕Фр╕╡р╕Вр╕нр╕Зр╕Бр╕▓р╕гр╣Гр╕Кр╣Й Helper:

1. **р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕нр╕Фр╕Др╕ер╣Йр╕нр╕Зр╕Бр╕▒р╕Щ** - р╕нр╕▒р╕Ыр╣Ар╕Фр╕Хр╕Чр╕▒р╣Йр╕З 2 р╕Хр╕▓р╕гр╕▓р╕Зр╕Юр╕гр╣Йр╕нр╕бр╕Бр╕▒р╕Щ
2. **р╕Ыр╣Йр╕нр╕Зр╕Бр╕▒р╕Щ Race Condition** - р╣Гр╕Кр╣Й `lockForUpdate()`
3. **р╣Гр╕Кр╣Й Transaction** - Rollback р╕нр╕▒р╕Хр╣Вр╕Щр╕бр╕▒р╕Хр╕┤р╕Цр╣Йр╕▓р╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Ф
4. **р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕зр╕▓р╕бр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З** - р╣Ар╕Кр╣Зр╕Др╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣р╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕н
5. **Return р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Др╕гр╕Ър╕Цр╣Йр╕зр╕Щ** - р╕гр╕╣р╣Йр╕Бр╣Ир╕нр╕Щ-р╕лр╕ер╕▒р╕Зр╕Бр╕▓р╕гр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Бр╕Ыр╕ер╕З
6. **Error Message р╕Кр╕▒р╕Фр╣Ар╕Ир╕Щ** - р╕Ър╕нр╕Бр╕кр╕▓р╣Ар╕лр╕Хр╕╕р╕нр╕вр╣Ир╕▓р╕Зр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф

### ЁЯОп р╣Ар╕бр╕╖р╣Ир╕нр╣Др╕лр╕гр╣Ир╕Др╕зр╕гр╣Гр╕Кр╣Й:

- тЬЕ р╕Лр╕╖р╣Йр╕нр╕лр╕бр╕╣р╣Ар╕Вр╣Йр╕▓ (`addPigs`)
- тЬЕ р╕Вр╕▓р╕вр╕лр╕бр╕╣ (`reducePigInventory`)
- тЬЕ р╕лр╕бр╕╣р╕Хр╕▓р╕в (`reducePigInventory`)
- тЬЕ р╕Др╕▒р╕Фр╕лр╕бр╕╣р╕Чр╕┤р╣Йр╕З (`reducePigInventory`)
- тЬЕ р╕вр╕Бр╣Ар╕ер╕┤р╕Бр╕Бр╕▓р╕гр╕Вр╕▓р╕в (`increasePigInventory`)
- тЬЕ р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Ир╕│р╕Щр╕зр╕Щр╕лр╕бр╕╣ (`getPigsByBatch`, `getPigsByPen`)

---

**р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕г:** 12 р╕Хр╕╕р╕ер╕▓р╕Др╕б 2025  
**р╕Ьр╕╣р╣Йр╕кр╕гр╣Йр╕▓р╕З:** GitHub Copilot  
**р╣Ар╕зр╕нр╕гр╣Мр╕Кр╕▒р╕Щ:** 1.0
