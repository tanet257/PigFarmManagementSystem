# User Registration Cancel Workflow - Implementation Guide

## üéØ Overview

This guide explains how the user registration cancellation workflow and email notifications work in the Pig Farm Management System.

## üìã Key Components

### 1. Database Schema
```sql
-- Added to users table:
ALTER TABLE users ADD COLUMN cancellation_reason VARCHAR(255) NULLABLE;
ALTER TABLE users ADD COLUMN cancellation_requested_at TIMESTAMP NULLABLE;
```

### 2. User Model Methods

#### Check Cancellation Status
```php
$user->isCancelled()              // true if status = 'cancelled'
$user->hasCancellationRequest()   // true if cancellation_requested_at is set
```

### 3. Notification Types

| Type | Icon | Label | When Triggered |
|------|------|-------|-----------------|
| user_registered | üë§ fa-user-plus | ‡∏î‡∏π‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô | User registers |
| user_approved | ‚úÖ fa-check-circle | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥ | Admin approves |
| user_rejected | ‚ùå fa-times-circle | ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò | Admin rejects |
| user_registration_cancelled | ‚õî fa-ban | ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å | User/Admin cancels |

## üîÑ Workflow Diagram

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ USER REGISTRATION CANCEL WORKFLOW                              ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Step 1: User Requests Cancellation
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ User Status: Approved‚îÇ
‚îÇ Click: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"      ‚îÇ
‚îÇ Enter: Reason        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ requestCancelRegistration()              ‚îÇ
‚îÇ ‚úì Set cancellation_reason                ‚îÇ
‚îÇ ‚úì Set cancellation_requested_at          ‚îÇ
‚îÇ ‚úì Create notification                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚ñº
Step 2: Admin Receives Notification
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Admin Dashboard                          ‚îÇ
‚îÇ Notification: "User X ‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"          ‚îÇ
‚îÇ Type: user_registration_cancelled       ‚îÇ
‚îÇ Route: user_management.index             ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
        ‚îÇ
        ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
        ‚ñº                    ‚ñº                     ‚ñº
    APPROVE              REJECT              (No Action)
        ‚îÇ                  ‚îÇ                       ‚îÇ
        ‚ñº                  ‚ñº                       ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
‚îÇ status='    ‚îÇ    ‚îÇ Clear:      ‚îÇ               ‚îÇ
‚îÇ cancelled'  ‚îÇ    ‚îÇ - reason    ‚îÇ               ‚îÇ
‚îÇ             ‚îÇ    ‚îÇ - timestamp ‚îÇ               ‚îÇ
‚îÇ Send Email: ‚îÇ    ‚îÇ             ‚îÇ               ‚îÇ
‚îÇ UserReg     ‚îÇ    ‚îÇ User keeps  ‚îÇ               ‚îÇ
‚îÇ Cancelled   ‚îÇ    ‚îÇ approved    ‚îÇ               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ status      ‚îÇ               ‚îÇ
        ‚îÇ          ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò               ‚îÇ
        ‚ñº                ‚îÇ                        ‚îÇ
    User Notified    User Notified           User Remains
    Account Closed   (rejection)             Approved
```

## üöÄ API Endpoints

### 1. Request Cancellation
```http
POST /user_management/{id}/request_cancel

Request Body:
{
    "reason": "‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å"
}

Response:
- Success: Redirect to user_management.index with success message
- Error: Redirect with error message
```

### 2. Approve Cancellation
```http
PATCH /user_management/{id}/approve_cancel

Response:
- User status updated to 'cancelled'
- Email sent to user
- Admin notification updated
```

### 3. Reject Cancellation
```http
PATCH /user_management/{id}/reject_cancel

Response:
- Cancellation request cleared
- User status remains 'approved'
- User notified
```

## üìß Email Configuration

### Required .env Settings
```env
MAIL_DRIVER=smtp
MAIL_HOST=smtp.gmail.com
MAIL_PORT=587
MAIL_USERNAME=your-email@gmail.com
MAIL_PASSWORD=your-app-password
MAIL_ENCRYPTION=tls
MAIL_FROM_NAME="Pig Farm System"
MAIL_FROM_ADDRESS=your-email@gmail.com
```

### Gmail App Password Setup

1. Go to https://myaccount.google.com/
2. Click "Security" on the left sidebar
3. Enable 2-Step Verification
4. Search "App passwords"
5. Select "Mail" and "Windows Computer"
6. Copy the generated password
7. Paste in `.env` as `MAIL_PASSWORD`

### Testing Email Locally

```php
// In tinker or test
Mail::to('test@example.com')->send(new UserRegistrationApproved($user, $approvedBy));
```

## üì® Email Templates

### Approved Email
- Subject: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡πÅ‡∏•‡πâ‡∏ß"
- Template: `resources/views/emails/user_registration_approved.blade.php`
- Contains: Name, email, role, approval date

### Rejected Email
- Subject: "‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ñ‡∏π‡∏Å‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò"
- Template: `resources/views/emails/user_registration_rejected.blade.php`
- Contains: Rejection reason, approver name, date

### Cancelled Email
- Subject: "‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß"
- Template: `resources/views/emails/user_registration_cancelled.blade.php`
- Contains: Cancellation date, account closure notice

## üîê Security & Validation

### Validation Checks

```php
// Request Cancellation
if ($user->isCancelled()) {
    return error('‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÅ‡∏•‡πâ‡∏ß');
}

if ($user->hasCancellationRequest()) {
    return warning('‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß');
}

// Approve/Reject
if (!$user->hasCancellationRequest()) {
    return error('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å');
}
```

### Permission Checks

- Only authenticated users can request cancellation
- Only admin users can approve/reject
- User cannot cancel their own account (must request first)

## üé® UI Components

### Notification Button
```blade
<!-- Notification appears in notifications dashboard -->
<a href="{{ route('notifications.mark_and_navigate', $notification->id) }}"
   class="btn btn-sm {{ $notification->is_read ? 'btn-info' : 'btn-warning' }}">
    <i class="fa fa-ban"></i>
    {{ $notification->type === 'user_registration_cancelled' ? '‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å' : '...' }}
</a>
```

### User Management View
```blade
@if ($user->hasCancellationRequest())
    <!-- Approve/Reject Buttons -->
    <form action="{{ route('user_management.approve_cancel', $user->id) }}" method="POST">
        @csrf
        @method('PATCH')
        <button type="submit" class="btn btn-sm btn-warning">
            <i class="bi bi-check"></i> ‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
    </form>
    
    <form action="{{ route('user_management.reject_cancel', $user->id) }}" method="POST">
        @csrf
        @method('PATCH')
        <button type="submit" class="btn btn-sm btn-secondary">
            <i class="bi bi-x"></i> ‡∏õ‡∏è‡∏¥‡πÄ‡∏™‡∏ò‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å
        </button>
    </form>
@elseif ($user->status === 'cancelled')
    <!-- Show Cancelled Badge -->
    <span class="badge bg-danger">
        <i class="bi bi-ban"></i> ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô
    </span>
@endif
```

## üß™ Testing Checklist

- [ ] User can request cancellation
- [ ] Cancellation reason is required
- [ ] Admin receives notification
- [ ] Admin can approve cancellation
- [ ] Admin can reject cancellation
- [ ] Cancelled user cannot login
- [ ] Email sent on approval
- [ ] Email sent on rejection
- [ ] Email sent on cancellation
- [ ] Notification routes correctly
- [ ] User status updates correctly
- [ ] Cancellation fields cleared on rejection

## üìä Database Queries

### Find Pending Cancellations
```sql
SELECT * FROM users 
WHERE status = 'approved' 
AND cancellation_requested_at IS NOT NULL;
```

### Find Cancelled Users
```sql
SELECT * FROM users 
WHERE status = 'cancelled';
```

### Check Notification History
```sql
SELECT * FROM notifications 
WHERE type = 'user_registration_cancelled' 
ORDER BY created_at DESC;
```

## üîß Troubleshooting

### Issue: Email Not Sending
**Solution**: Check MAIL_DRIVER in .env
```env
MAIL_DRIVER=smtp  # Not 'mail' or 'sendmail'
```

### Issue: Notification Not Appearing
**Solution**: Check route registration
```php
# In routes/web.php
Route::patch('/{id}/approve_cancel', [UserManagementController::class, 'approveCancelRegistration'])
    ->name('user_management.approve_cancel');
```

### Issue: User Can't Request Cancellation
**Solution**: Check user status
```php
if ($user->status !== 'approved') {
    // User must be approved to request cancellation
}
```

## üìû Related Documentation

- [Cancel Request UI Update](./CANCEL_REQUEST_UI_UPDATE.md)
- [Payment Approval System](./APPROVAL_SYSTEM_COMPLETE.md)
- [Notification System Expansion](./NOTIFICATION_SYSTEM_EXPANSION.md)
- [Role Permission System](./ROLE_PERMISSION_SYSTEM.md)

## üìù File Structure

```
app/
‚îú‚îÄ‚îÄ Http/Controllers/
‚îÇ   ‚îú‚îÄ‚îÄ UserManagementController.php (updated)
‚îÇ   ‚îî‚îÄ‚îÄ NotificationController.php (updated)
‚îú‚îÄ‚îÄ Mail/
‚îÇ   ‚îú‚îÄ‚îÄ UserRegistrationApproved.php (new)
‚îÇ   ‚îú‚îÄ‚îÄ UserRegistrationRejected.php (new)
‚îÇ   ‚îî‚îÄ‚îÄ UserRegistrationCancelled.php (new)
‚îú‚îÄ‚îÄ Models/
‚îÇ   ‚îî‚îÄ‚îÄ User.php (updated)
‚îú‚îÄ‚îÄ Helpers/
‚îÇ   ‚îî‚îÄ‚îÄ NotificationHelper.php (updated)

database/
‚îî‚îÄ‚îÄ migrations/
    ‚îî‚îÄ‚îÄ 2025_10_22_030218_add_cancellation_fields_to_users.php (new)

resources/views/
‚îú‚îÄ‚îÄ emails/
‚îÇ   ‚îú‚îÄ‚îÄ user_registration_approved.blade.php (new)
‚îÇ   ‚îú‚îÄ‚îÄ user_registration_rejected.blade.php (new)
‚îÇ   ‚îî‚îÄ‚îÄ user_registration_cancelled.blade.php (new)
‚îî‚îÄ‚îÄ admin/
    ‚îú‚îÄ‚îÄ notifications/index.blade.php (updated)
    ‚îî‚îÄ‚îÄ user_management/index.blade.php (updated)

routes/
‚îî‚îÄ‚îÄ web.php (updated - 3 new routes)
```

## ‚úÖ Implementation Status

- [x] Database migration created and run
- [x] User model updated with new methods
- [x] UserManagementController enhanced with 3 new methods
- [x] NotificationHelper updated with email methods
- [x] NotificationController routing updated
- [x] 3 Mail classes created
- [x] 3 Email templates created
- [x] Routes added
- [x] UI buttons added to user management
- [x] Notification icons updated
- [x] All syntax validated
- [x] Documentation created

## üéâ Ready for Testing!

The user registration cancellation workflow is now fully implemented. Test it in your environment and adjust email templates as needed.
